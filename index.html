<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–æ–≤</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU"></script>

<style>
html,body{margin:0;height:100%;font-family:Arial}
#map{position:absolute;inset:0}

#panel{
    position:absolute;right:10px;top:10px;z-index:10;
    width:360px;max-height:90%;
    background:rgba(255,255,255,.95);
    border-radius:8px;padding:8px;overflow:auto
}

#list{
    max-height:200px; /* –≤—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–æ—á–µ–∫ */
    overflow-y:auto;  /* –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
    border:1px solid #ccc;
    padding:2px;
    margin-top:5px;
}

#list div{
    padding:6px;
    border-bottom:1px solid #ddd;
    cursor:pointer;
    word-break: break-word;
    white-space: pre-wrap;
}
#list div.active{
    background:#d0f5d0;font-weight:bold
}

textarea, input, button{
    width:100%;
    margin-top:5px;
    box-sizing: border-box;
}

textarea{
    resize: vertical;
}

.command-block{
    margin-bottom:5px;
    border:1px solid #ccc;
    padding:3px;
    border-radius:4px;
    position: relative;
}
.command-block textarea{
    width:100%;
    height:40px;
}
.command-block button{
    position:absolute;
    right:3px;
    top:3px;
    width:auto;
    height:auto;
    padding:2px 6px;
    font-size:12px;
}

#cmdContainer{
    max-height: 130px; /* 3 –∫–æ–º–∞–Ω–¥—ã –ø–æ 40px + –æ—Ç—Å—Ç—É–ø—ã ‚âà 130px */
    overflow-y:auto;
}

.az-btns button{
    width:48%;font-size:18px
}

.coord {
    margin-top: 5px;
    font-size: 14px;
    color: #333;
}
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
<b>–ú–∞—Ä—à—Ä—É—Ç</b>
<div id="list"></div>

<hr>
<b>–ö–æ–º–∞–Ω–¥—ã —Ç–æ—á–∫–∏</b>
<div id="cmdContainer"></div>
<button onclick="addCommand()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É</button>

<hr>
<b>–¢–æ—á–∫–∞</b>
<div class="az-btns">
<button onclick="rotate(-10)">‚ü≤ ‚àí10¬∞</button>
<button onclick="rotate(10)">‚ü≥ +10¬∞</button>
</div>
<input id="az" type="number" placeholder="–ê–∑–∏–º—É—Ç">

<div class="coord" id="coord">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ‚Äî , ‚Äî</div>

<button onclick="removePoint()">–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É</button>
<button onclick="exportJSON()">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
<button onclick="importJSON()">–ò–º–ø–æ—Ä—Ç JSON</button>
</div>

<script>
let map;
let points = [];
let current = null;

/* INIT */
ymaps.ready(()=>{
    map = new ymaps.Map("map", {
        center: [56.3399,43.9332],
        zoom: 18,
        type: 'yandex#satellite',
        controls: []
    });

    map.events.add('click', e=>{
        const c = e.get('coords');
        const newPoint = addPoint(c);
        scrollToCurrentPoint(); // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ –Ω–æ–≤–æ–π —Ç–æ—á–∫–µ
    });
});

/* SVG —Å—Ç—Ä–µ–ª–∫–∏ */
function arrowSVG(a, color){
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
<g transform="rotate(${a},20,20)">
<polygon points="20,2 28,30 20,24 12,30" fill="${color}"/>
</g>
</svg>`);
}

/* ADD POINT */
function addPoint(coords){
    const p = {
        lat: coords[0],
        lon: coords[1],
        azimuth: 0,
        commands: [''],
        pm: null
    };

    p.pm = new ymaps.Placemark(coords, {}, {
        iconLayout: 'default#image',
        iconImageHref: arrowSVG(0,'blue'),
        iconImageSize: [40,40],
        iconImageOffset: [-20,-20],
        draggable: true
    });

    p.pm.events.add('click', () => selectPoint(p));
    p.pm.events.add('dragstart', () => selectPoint(p));
    p.pm.events.add('geometrychange', () => {
        const newCoords = p.pm.geometry.getCoordinates();
        p.lat = newCoords[0];
        p.lon = newCoords[1];
        if(current !== p) selectPoint(p);
    });

    map.geoObjects.add(p.pm);
    points.push(p);
    selectPoint(p);
    renderList();
    return p;
}

/* SELECT POINT */
function selectPoint(p){
    current = p;
    renderCmdContainer();
    renderList();
    updateMarker(p);
    updateCoord();
    scrollToCurrentPoint(); // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–µ
}

/* LIST OF POINTS */
function renderList(){
    list.innerHTML = '';
    points.forEach(p=>{
        const d = document.createElement('div');
        const cmdText = p.commands[0] || '(–±–µ–∑ –∫–æ–º–∞–Ω–¥—ã)';
        d.textContent = cmdText;
        if(p===current) d.classList.add('active');
        d.onclick = ()=>selectPoint(p);
        list.appendChild(d);
    });
}

/* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –∫ —Ç–µ–∫—É—â–µ–π —Ç–æ—á–∫–µ */
function scrollToCurrentPoint(){
    if(!current) return;
    const items = list.querySelectorAll('div');
    const idx = points.indexOf(current);
    if(items[idx]) items[idx].scrollIntoView({behavior:"smooth", block:"nearest"});
}

/* COMMANDS PANEL */
function renderCmdContainer(){
    cmdContainer.innerHTML = '';
    if(!current) return;

    current.commands.forEach((cmd, idx)=>{
        const block = document.createElement('div');
        block.className = 'command-block';

        const ta = document.createElement('textarea');
        ta.value = cmd;
        ta.oninput = ()=> {
            current.commands[idx] = ta.value;
            renderList();
        };
        block.appendChild(ta);

        const del = document.createElement('button');
        del.textContent = 'üóë';
        del.onclick = ()=> {
            current.commands.splice(idx,1);
            renderCmdContainer();
            renderList();
        };
        block.appendChild(del);

        cmdContainer.appendChild(block);
    });

    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥–µ
    if(current.commands.length > 0){
        cmdContainer.scrollTop = cmdContainer.scrollHeight;
    }
}

/* COMMANDS MANAGEMENT */
function addCommand(){
    if(!current) return;
    current.commands.push('');
    renderCmdContainer();
    renderList();
}

/* AZIMUTH */
az.oninput = ()=>{
    if(!current) return;
    current.azimuth = ((+az.value % 360)+360)%360;
    updateMarker(current);
};

function rotate(d){
    if(!current) return;
    current.azimuth = (current.azimuth + d + 360) % 360;
    az.value = current.azimuth;
    updateMarker(current);
}

/* UPDATE MARKER */
function updateMarker(p){
    p.pm.options.set('iconImageHref', arrowSVG(p.azimuth, p===current?'green':'blue'));
}

/* COORD DISPLAY */
function updateCoord(){
    if(!current) {
        coord.textContent = "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ‚Äî , ‚Äî";
        return;
    }
    coord.textContent = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${current.lat.toFixed(6)} , ${current.lon.toFixed(6)}`;
}

/* REMOVE POINT */
function removePoint(){
    if(!current) return;
    map.geoObjects.remove(current.pm);
    points = points.filter(p=>p!==current);
    current=null;
    updateCoord();
    renderList();
    cmdContainer.innerHTML = '';
}

/* EXPORT JSON */
function exportJSON() {
    const data = points.map(p => ({
        lat: p.lat,
        lon: p.lon,
        azimuth: p.azimuth,
        commands: p.commands
    }));

    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob(["\uFEFF" + jsonStr], { type: 'application/json;charset=utf-8' });

    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'route.json';
    a.click();
}

/* IMPORT JSON */
function importJSON() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,application/json';
    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const imported = JSON.parse(ev.target.result);

                points.forEach(p => map.geoObjects.remove(p.pm));
                points = [];
                current = null;

                imported.forEach(p => {
                    const newPoint = addPoint([p.lat, p.lon]);
                    newPoint.azimuth = p.azimuth;
                    newPoint.commands = p.commands.length ? p.commands : [''];
                    updateMarker(newPoint);
                });

                renderList();
                updateCoord();
                alert('–ú–∞—Ä—à—Ä—É—Ç —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!');
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ JSON: ' + err);
            }
        };
        reader.readAsText(file, 'UTF-8');
    };
    input.click();
}
</script>
</body>
</html>
