<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–æ–≤</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU"></script>

<style>
html, body {margin:0; height:100%; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
#map {position:absolute; inset:0;}

/* –ü–∞–Ω–µ–ª—å */
#panel {
    position:absolute; right:0; top:0; z-index:10;
    width: min(380px, 90%);
    max-width:90%;
    max-height:90%;
    background: rgba(255,255,255,0.85);
    border-radius:16px; padding:16px;
    box-shadow: 0 12px 32px rgba(0,0,0,0.2);
    overflow:auto;
    transition: transform 0.3s ease, width 0.3s ease;
    min-width:200px;
}
@media (max-width: 500px) {
    #panel { width:100%; left:0; right:0; border-radius:0; }
}

#togglePanelBtn {
    position:absolute;
    top:10px; right:10px; z-index:20;
    width:36px; height:36px;
    border:none; border-radius:50%;
    background:#4CAF50; color:white; font-size:20px;
    cursor:pointer; display:flex; align-items:center; justify-content:center;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
#togglePanelBtn:hover {background:#45a049;}

/* –ö–Ω–æ–ø–∫–∏ –∞–∑–∏–º—É—Ç–∞ */
.az-btns {display:flex; gap:8px; margin-bottom:8px;}
.az-btns button {
    flex:1; font-size:20px; padding:12px;
    border:none; border-radius:10px;
    background:#4CAF50; color:white; cursor:pointer;
    transition: background 0.2s;
}
.az-btns button:hover {background:#45a049;}

/* –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã */
.coord {margin-top:8px; font-size:14px; color:#555;}

/* –ö–æ–º–∞–Ω–¥—ã —Ç–æ—á–∫–∏ */
.commands-display {
    margin-top:10px;
    padding:8px;
    background:#f0f0f0;
    border-radius:10px;
    cursor:pointer;
    white-space: pre-wrap;
    min-height:40px;
}
.commands-display:hover {background:#e0e0e0;}

/* –ü–æ–ª–µ –∏ –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã */
.add-command-container { display:flex; gap:6px; margin-top:8px; }
.add-command-container input { flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
.add-command-container button { flex:none; width:50px; font-size:18px; padding:0; border:none; border-radius:8px; background:#4CAF50; color:white; cursor:pointer; }
.add-command-container button:hover { background:#45a049; }

/* –ö–Ω–æ–ø–∫–∏ –ø–∞–Ω–µ–ª–∏ */
button.panel-btn {
    padding:8px; border:none; border-radius:10px;
    background:#4CAF50; color:white; font-size:14px;
    cursor:pointer; margin-top:6px; width:100%;
    transition: background 0.2s;
}
button.panel-btn:hover {background:#45a049;}

/* –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ */
.command-dropdown {
    position: absolute;
    right:10px;
    top:10px;
    width:380px;
    max-height:90vh;
    overflow-y:auto;
    background: #ffffff;
    padding:16px;
    border-radius:16px;
    box-shadow: 0 12px 32px rgba(0,0,0,0.2);
    z-index:1001;
    transform: translateY(-10px);
    opacity:0;
    transition: transform 0.3s ease, opacity 0.3s ease;
}
.command-dropdown.show {transform: translateY(0); opacity:1;}

.command-dropdown label {
    display:flex; align-items:center; margin:6px 0;
    cursor:pointer; font-size:14px; border-radius:6px; padding:4px 6px;
    transition: background 0.2s;
}
.command-dropdown label:hover {background: rgba(76,175,80,0.1);}
.command-dropdown input[type="checkbox"] {
    appearance:none; width:20px; height:20px; border:2px solid #ccc;
    border-radius:50%; margin-right:10px; position:relative;
    transition:border-color 0.3s, background-color 0.3s;
}
.command-dropdown input[type="checkbox"]:checked {
    border-color:#4CAF50; background-color:#4CAF50;
}
.command-dropdown input[type="checkbox"]:checked::after {
    content:''; position:absolute; top:4px; left:4px; width:8px; height:8px; border-radius:50%; background:#fff;
}
.command-dropdown input[type="checkbox"]:checked + span { color:#4CAF50; font-weight:500; }
.command-dropdown span { user-select:none; }
</style>
</head>
<body>

<div id="map"></div>
<button id="togglePanelBtn" onclick="togglePanel()">‚ò∞</button>

<div id="panel">
    <div class="az-btns">
        <button onclick="rotate(-10)">‚ü≤ ‚àí10¬∞</button>
        <button onclick="rotate(10)">‚ü≥ +10¬∞</button>
    </div>
    <div class="coord" id="coord">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ‚Äî , ‚Äî | –ê–∑–∏–º—É—Ç: ‚Äî¬∞</div>
    <div class="commands-display" onclick="toggleCommandDropdown()">(–Ω–µ—Ç –∫–æ–º–∞–Ω–¥)</div>

    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–º–∞–Ω–¥—ã —Å –∫–Ω–æ–ø–∫–æ–π —Å–ø—Ä–∞–≤–∞ -->
    <div class="add-command-container">
        <input type="text" id="customCommandInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É...">
        <button onclick="addCustomCommand()">‚úÖ</button>
    </div>

    <button class="panel-btn" onclick="removePoint()">–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É</button>
    <hr>
    <button class="panel-btn" onclick="exportJSON()">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <button class="panel-btn" onclick="importJSON()">–ò–º–ø–æ—Ä—Ç JSON</button>
    <hr>
    <button class="panel-btn" onclick="updateGist()">üíæ –û–±–Ω–æ–≤–∏—Ç—å Gist</button>
    <button class="panel-btn" onclick="loadFromGist()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Gist</button>
</div>

<script>
let map, points=[], current=null;
const GITHUB_TOKEN='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';
const GIST_ID='c4b196bd97194e06592b94646e02118b';
const GIST_FILENAME='all.json';
const COMMAND_OPTIONS=[
    '–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ','–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–µ–¥–µ–º –ø—Ä—è–º–æ','–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ',
    '–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –≤—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç','–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –ø–µ—Ä–≤—ã–π —Å—ä–µ–∑–¥','–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –≤—Ç–æ—Ä–æ–π —Å—ä–µ–∑–¥',
    '–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —Ç—Ä–µ—Ç–∏–π —Å—ä–µ–∑–¥','–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —á–µ—Ç–≤–µ—Ä—Ç—ã–π —Å—ä–µ–∑–¥',
    '–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞','–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–º –º–µ—Å—Ç–µ',
    '–ù–∞ –±–ª–∏–∂–∞–π—à–µ–º –ø–æ–≤–æ—Ä–æ—Ç–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ','–ù–∞ –±–ª–∏–∂–∞–π—à–µ–º –ø–æ–≤–æ—Ä–æ—Ç–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ',
    '–ù–∞–π–¥–∏—Ç–µ –º–µ—Å—Ç–æ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å','–í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∫—Ä–∞—é –ø—Ä–æ–µ–∑–∂–µ–π —á–∞—Å—Ç–∏',
    '–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏','–ù–∞–±–∏—Ä–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –¥–∞–Ω–Ω–æ–º —É—á–∞—Å—Ç–∫–µ –¥–æ—Ä–æ–≥–∏',
    '–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ','–í—ã–ø–æ–ª–Ω–∏–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ'
];

const coord=document.getElementById('coord');
const commandsDisplay=document.querySelector('.commands-display');
const panel=document.getElementById('panel');
let panelVisible=true;

ymaps.ready(()=>{
    map=new ymaps.Map("map",{center:[56.3399,43.9332],zoom:18,type:'yandex#satellite',controls:[]});
    map.events.add('click',e=>addPoint(e.get('coords')));
});

function arrowSVG(a,color){
    return 'data:image/svg+xml;utf8,'+encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
            <g transform="rotate(${a},20,20)">
                <polygon points="20,2 28,30 20,24 12,30" fill="${color}" stroke="black" stroke-width="1"/>
            </g>
        </svg>`);
}

function addPoint(coords){
    const p={lat:coords[0],lon:coords[1],azimuth:0,commands:[],pm:null};
    p.pm=new ymaps.Placemark(coords,{},{
        iconLayout:'default#image',
        iconImageHref:arrowSVG(0,'gray'),
        iconImageSize:[40,40],
        iconImageOffset:[-20,-20],
        draggable:true
    });
    p.pm.events.add('click',()=>selectPoint(p));
    p.pm.events.add('dragstart',()=>selectPoint(p));
    p.pm.events.add('geometrychange',()=>{
        const c=p.pm.geometry.getCoordinates();
        p.lat=c[0]; p.lon=c[1];
        if(current!==p) selectPoint(p);
    });
    map.geoObjects.add(p.pm);
    points.push(p);
    selectPoint(p);
    updateAllMarkers();
}

function selectPoint(p){current=p; updateCoord(); updateCommandsDisplay(); updateAllMarkers();}
function rotate(d){if(!current)return; current.azimuth=(current.azimuth+d+360)%360; updateCoord(); updateAllMarkers();}
function updateAllMarkers(){
    points.forEach(p=>{
        let color;
        if(p===current) color='green';
        else if(!p.commands||p.commands.length===0) color='gray';
        else color='blue';
        p.pm.options.set('iconImageHref',arrowSVG(p.azimuth,color));
    });
}
function updateCoord(){coord.textContent=current?`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${current.lat.toFixed(6)} , ${current.lon.toFixed(6)} | –ê–∑–∏–º—É—Ç: ${current.azimuth}¬∞`:'–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ‚Äî , ‚Äî | –ê–∑–∏–º—É—Ç: ‚Äî¬∞';}
function updateCommandsDisplay(){commandsDisplay.textContent=!current||current.commands.length===0?'(–Ω–µ—Ç –∫–æ–º–∞–Ω–¥)':current.commands.join('\n');}
function removePoint(){if(!current)return; map.geoObjects.remove(current.pm); points=points.filter(p=>p!==current); current=null; updateCoord(); updateCommandsDisplay(); updateAllMarkers();}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã
function addCustomCommand(){
    if(!current) return;
    const input = document.getElementById('customCommandInput');
    const val = input.value.trim();
    if(!val) return;
    current.commands.push(val);
    input.value='';
    updateCommandsDisplay();
    updateAllMarkers();
}

// –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ —Å –∫–Ω–æ–ø–∫–∞–º–∏ "–ì–æ—Ç–æ–≤–æ" –∏ "–û—Ç–º–µ–Ω–∞"
function toggleCommandDropdown(){
    if(!current) return;
    const existing=document.querySelector('.command-dropdown');
    if(existing){existing.classList.remove('show'); setTimeout(()=>existing.remove(),300); return;}

    const panelRect=panel.getBoundingClientRect();
    const dropdown=document.createElement('div');
    dropdown.className='command-dropdown';
    dropdown.style.top=panelRect.top+'px';
    dropdown.style.right=(window.innerWidth-panelRect.right)+'px';
    dropdown.style.width=panelRect.width+'px';
    dropdown.style.maxHeight=(window.innerHeight-panelRect.top-10)+'px';

    COMMAND_OPTIONS.forEach(option=>{
        const label=document.createElement('label');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=option; cb.checked=current.commands.includes(option);
        const span=document.createElement('span'); span.textContent=option;
        label.appendChild(cb); label.appendChild(span);
        dropdown.appendChild(label);
    });

    // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫ "–ì–æ—Ç–æ–≤–æ" –∏ "–û—Ç–º–µ–Ω–∞"
    const btnContainer=document.createElement('div');
    btnContainer.style.display='flex'; btnContainer.style.gap='8px'; btnContainer.style.marginTop='12px';

    const doneBtn=document.createElement('button');
    doneBtn.textContent='–ì–æ—Ç–æ–≤–æ';
    doneBtn.style.cssText='flex:1;padding:10px;font-size:16px;border:none;border-radius:10px;background:#4CAF50;color:white;cursor:pointer;';
    doneBtn.onclick=()=>{
        const selected=[]; dropdown.querySelectorAll('input:checked').forEach(c=>selected.push(c.value));
        current.commands=selected; updateCommandsDisplay(); updateAllMarkers();
        dropdown.classList.remove('show'); setTimeout(()=>dropdown.remove(),300);
    };
    btnContainer.appendChild(doneBtn);

    const cancelBtn=document.createElement('button');
    cancelBtn.textContent='–û—Ç–º–µ–Ω–∞';
    cancelBtn.style.cssText='flex:1;padding:10px;font-size:16px;border:none;border-radius:10px;background:#ccc;color:white;cursor:pointer;';
    cancelBtn.onclick=()=>{
        dropdown.classList.remove('show'); setTimeout(()=>dropdown.remove(),300);
    };
    btnContainer.appendChild(cancelBtn);

    dropdown.appendChild(btnContainer);
    document.body.appendChild(dropdown);
    setTimeout(()=>dropdown.classList.add('show'),10);
}

// –°–∫—Ä—ã—Ç–∏–µ/–ø–æ–∫–∞–∑ –ø–∞–Ω–µ–ª–∏
function togglePanel(){panelVisible=!panelVisible; if(panelVisible) panel.style.transform='translateX(0)'; else panel.style.transform='translateX(420px)';}
</script>

</body>
</html>
