<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–æ–≤</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU"></script>
<style>
html,body{margin:0;height:100%;font-family:'Inter',Arial}
#map{position:absolute;inset:0}

/* PANEL */
#panel{
    position:absolute; right:10px; top:10px;
    width:360px; max-width:95%;
    background:rgba(255,255,255,0.28);
    backdrop-filter:blur(20px);
    border-radius:16px; padding:16px;
    z-index:1000;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
    transition:transform .3s ease, opacity .3s ease;
}
#panel.collapsed{transform:translateX(110%);opacity:0.3;}

/* TOGGLE BUTTON */
#panelToggle{
    position:fixed; top:12px; right:12px;
    width:44px;height:44px;
    border-radius:50%;
    background:linear-gradient(135deg,#4a90e2,#2f80ed);
    color:white; border:none; cursor:pointer;
    font-size:22px; z-index:1001;
    box-shadow:0 4px 12px rgba(0,0,0,0.35);
}
#panelToggle:hover{background:linear-gradient(135deg,#6aa6f3,#3f90ff);}

/* UI */
button,input{margin-top:8px;border-radius:12px;font-size:14px;padding:10px;border:1px solid rgba(0,0,0,0.15);outline:none;transition:all .2s ease;}
input:focus{border-color:#2f80ed;box-shadow:0 0 8px rgba(47,128,237,0.4);}
button{background:#2f80ed;color:white;border:none;cursor:pointer;}
button.secondary{background:#aaa} button.danger{background:#e74c3c}
button:hover{opacity:0.85}

/* Azimuth */
.az-row{display:flex;gap:8px} .az-row button{height:56px;font-size:20px;flex:1;}

/* Info */
.info{margin-top:8px;font-size:14px;white-space:pre-line;cursor:pointer;padding:10px;border-radius:12px;background:rgba(0,0,0,0.05);transition:background .2s ease;}
.info:hover{background:rgba(0,0,0,0.08);}

/* Command dropdown */
.command-dropdown{
    position:fixed; right:10px; top:10px;
    width:360px; max-width:95%; max-height:calc(100vh-20px);
    background:rgba(255,255,255,0.95);
    border-radius:16px;padding:16px;
    box-shadow:0 20px 40px rgba(0,0,0,0.35);
    overflow:auto; z-index:1000; display:flex; flex-direction:column; transition:opacity .3s ease;
}
.command-dropdown label{display:flex;gap:12px;align-items:center;padding:8px 6px;border-radius:8px;cursor:pointer;transition:background .2s ease;}
.command-dropdown label:hover{background:rgba(47,128,237,0.08);}
.command-dropdown input[type=checkbox]{width:18px;height:18px;}
.cmd-buttons{display:flex;gap:12px;margin-top:12px}
.cmd-buttons button{flex:1;padding:10px 0;font-weight:bold;border-radius:12px;}
.cmd-buttons button.secondary{background:#aaa;} .cmd-buttons button:hover{opacity:0.9}

/* Token prompt */
#tokenPrompt{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:2000;
}
#tokenPrompt div{
    background:white;padding:24px;border-radius:16px;max-width:90%;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.35);
}
#tokenPrompt input{width:100%;margin-top:12px;}
#tokenPrompt button{margin-top:12px;width:100%;}
#tokenError{color:red;margin-top:8px;font-size:14px;}

/* Custom command row */
#customCmdRow{display:flex;gap:6px; margin-top:8px;}
#customCmdRow input{flex:1;} /* —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –ø–æ–ª–µ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –ø–∞–Ω–µ–ª–∏ */
#customCmdRow button{width:60px;}
</style>
</head>
<body>

<div id="map"></div>

<!-- Toggle panel -->
<button id="panelToggle" onclick="togglePanel()">‚Æú</button>

<div id="panel">
    <div class="info" id="pointInfo" onclick="toggleCommandDropdown()">–¢–æ—á–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>

    <div class="az-row">
        <button onclick="rotate(-10)">‚ü≤</button>
        <button onclick="rotate(10)">‚ü≥</button>
    </div>

    <div class="info" id="coordInfo">‚Äî</div>

    <div id="customCmdRow">
        <input id="customCmd" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É">
        <button onclick="addCustomCommand()">‚úÖ</button>
    </div>

    <button class="danger" onclick="removePoint()">–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É</button>

    <hr>
    <button onclick="exportJSON()">üì§ –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <button onclick="importJSON()">üì• –ò–º–ø–æ—Ä—Ç JSON</button>

    <hr>
    <button onclick="updateGist()">üíæ –û–±–Ω–æ–≤–∏—Ç—å Gist</button>
</div>

<!-- Token prompt -->
<div id="tokenPrompt" style="display:none">
    <div>
        <div>–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω GitHub Gist:</div>
        <input type="text" id="gistTokenInput" placeholder="ghp_...">
        <button onclick="saveToken()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div id="tokenError"></div>
    </div>
</div>

<script>
let map, points=[], current=null;
let panelCollapsed=false;
let GITHUB_TOKEN=localStorage.getItem('GITHUB_TOKEN')||'';
const GIST_ID='c4b196bd97194e06592b94646e02118b';
const GIST_FILENAME='all.json';

const COMMANDS=[
'–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ','–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–µ–¥–µ–º –ø—Ä—è–º–æ','–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ','–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –≤—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç',
'–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –ø–µ—Ä–≤—ã–π —Å—ä–µ–∑–¥','–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –≤—Ç–æ—Ä–æ–π —Å—ä–µ–∑–¥','–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —Ç—Ä–µ—Ç–∏–π —Å—ä–µ–∑–¥','–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —á–µ—Ç–≤–µ—Ä—Ç—ã–π —Å—ä–µ–∑–¥',
'–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞','–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–º –º–µ—Å—Ç–µ',
'–ù–∞ –±–ª–∏–∂–∞–π—à–µ–º –ø–æ–≤–æ—Ä–æ—Ç–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ','–ù–∞ –±–ª–∏–∂–∞–π—à–µ–º –ø–æ–≤–æ—Ä–æ—Ç–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ',
'–ù–∞–π–¥–∏—Ç–µ –º–µ—Å—Ç–æ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å','–í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∫—Ä–∞—é –ø—Ä–æ–µ–∑–∂–µ–π —á–∞—Å—Ç–∏',
'–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏','–ù–∞–±–∏—Ä–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –¥–∞–Ω–Ω–æ–º —É—á–∞—Å—Ç–∫–µ –¥–æ—Ä–æ–≥–∏',
'–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ','–í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ'
];

function togglePanel(){
    const p=document.getElementById('panel');
    const b=document.getElementById('panelToggle');
    panelCollapsed=!panelCollapsed;
    p.classList.toggle('collapsed',panelCollapsed);
    b.textContent=panelCollapsed?'‚Æû':'‚Æú';
}

/* ===== TOKEN PROMPT ===== */
function showTokenPrompt(){document.getElementById('tokenPrompt').style.display='flex';}
async function saveToken(){
    const t=document.getElementById('gistTokenInput').value.trim();
    if(!t)return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω!');
    try{
        const r=await fetch(`https://api.github.com/gists/${GIST_ID}`,{headers:{'Authorization':'Bearer '+t}});
        if(!r.ok) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ Gist ID!');
        GITHUB_TOKEN=t;
        localStorage.setItem('GITHUB_TOKEN',GITHUB_TOKEN);
        document.getElementById('tokenPrompt').style.display='none';
        initMap();
    }catch(e){
        document.getElementById('tokenError').textContent=e.message;
    }
}

/* ===== MAP INIT ===== */
if(!GITHUB_TOKEN){ showTokenPrompt(); } else { initMap(); }

async function initMap(){
    ymaps.ready(async ()=>{
        map=new ymaps.Map("map",{center:[56.3399,43.9332],zoom:18,type:'yandex#satellite',controls:[]});
        map.events.add('click',e=>addPoint(e.get('coords')));
        await loadFromGist();
        setInterval(autoSaveGist,10000);
    });
}

/* SVG —Å—Ç—Ä–µ–ª–∫–∏ */
function arrowSVG(a,color){
    return 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><g transform="rotate(${a},20,20)"><polygon points="20,2 28,30 20,24 12,30" fill="${color}" stroke="black" stroke-width="1"/></g></svg>`);
}

/* POINTS */
function addPoint(c){
    const p = {lat: c[0], lon: c[1], azimuth: 0, commands: [], pm: null};
    p.pm = new ymaps.Placemark(c, {}, {
        iconLayout: 'default#image',
        iconImageHref: arrowSVG(0,'gray'),
        iconImageSize: [40,40],
        iconImageOffset: [-20,-20],
        draggable: true
    });

    p.pm.events.add('click', () => selectPoint(p));

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
    p.pm.events.add('dragend', e => {
        const coords = e.get('target').geometry.getCoordinates();
        p.lat = coords[0];
        p.lon = coords[1];
        updateInfo();
        updateAllMarkers();
    });

    map.geoObjects.add(p.pm);
    points.push(p);
    selectPoint(p);
    return p;
}

function selectPoint(p){current=p;updateInfo();updateAllMarkers();}
function removePoint(){if(!current)return; map.geoObjects.remove(current.pm); points=points.filter(x=>x!==current); current=null;updateInfo();updateAllMarkers();}

/* UI */
function updateInfo(){
    const i=document.getElementById('pointInfo'); 
    const c=document.getElementById('coordInfo');
    if(!current){
        i.textContent='–¢–æ—á–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞';
        c.textContent='‚Äî';
        return;
    }
    i.textContent = current.commands.length ? current.commands.join('\n') : '(–Ω–µ—Ç –∫–æ–º–∞–Ω–¥)';
    c.textContent = `${current.lat.toFixed(6)}, ${current.lon.toFixed(6)}\n–ê–∑–∏–º—É—Ç: ${current.azimuth}¬∞`;
}

function rotate(d){
    if(!current) return;
    current.azimuth = (current.azimuth + d + 360) % 360; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±—ä–µ–∫—Ç–µ —Ç–æ—á–∫–∏
    updateAllMarkers();
    updateInfo();
}

function updateAllMarkers(){
    points.forEach(p=>{
        let col='gray'; if(p.commands.length) col='blue'; if(p===current) col='green';
        p.pm.options.set('iconImageHref',arrowSVG(p.azimuth,col));
    });
}

/* COMMANDS DROPDOWN */
function toggleCommandDropdown(){
    if(!current)return;
    let d=document.querySelector('.command-dropdown');
    if(d){d.remove();return;}
    d=document.createElement('div'); d.className='command-dropdown';
    d.style.width=document.getElementById('panel').offsetWidth+'px';
    d.style.maxHeight=(window.innerHeight-20)+'px';
    COMMANDS.forEach(c=>{
        const l=document.createElement('label'); const cb=document.createElement('input');
        cb.type='checkbox'; cb.checked=current.commands.includes(c);
        l.appendChild(cb); l.appendChild(document.createTextNode(c));
        d.appendChild(l);
    });
    const btns=document.createElement('div'); btns.className='cmd-buttons';
    const ok=document.createElement('button'); ok.textContent='–ì–æ—Ç–æ–≤–æ';
    ok.onclick=()=>{current.commands=[...d.querySelectorAll('input:checked')].map(x=>x.parentNode.textContent.trim()); updateInfo(); updateAllMarkers(); d.remove();}
    const cancel=document.createElement('button'); cancel.textContent='–û—Ç–º–µ–Ω–∞'; cancel.className='secondary'; cancel.onclick=()=>d.remove();
    btns.append(ok,cancel); d.appendChild(btns); document.body.appendChild(d);
}

function addCustomCommand(){
    if(!current) return;
    const i=document.getElementById('customCmd'); 
    if(!i.value.trim()) return; 
    current.commands.push(i.value.trim()); 
    i.value=''; 
    updateInfo();
    updateAllMarkers();
}

/* JSON */
function exportJSON(){
    const data=points.map(p=>({lat:p.lat,lon:p.lon,azimuth:p.azimuth,commands:p.commands}));
    const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='route.json';a.click();
}
function importJSON(){
    const i=document.createElement('input');i.type='file';i.accept='.json';
    i.onchange=e=>{
        const r=new FileReader();
        r.onload=()=>{
            points.forEach(p=>map.geoObjects.remove(p.pm));
            points=[];
            JSON.parse(r.result).forEach(p=>{
                const np=addPoint([p.lat,p.lon]);
                np.azimuth=p.azimuth||0;
                np.commands=p.commands||[];
            });
            updateAllMarkers();
        };
        r.readAsText(e.target.files[0]);
    };
    i.click();
}

/* GIST */
async function updateGist(){
    if(!GITHUB_TOKEN) return;
    const data=points.map(p=>({lat:p.lat,lon:p.lon,azimuth:p.azimuth,commands:p.commands}));
    await fetch(`https://api.github.com/gists/${GIST_ID}`,{
        method:'PATCH',
        headers:{
            'Authorization':'Bearer '+GITHUB_TOKEN,
            'Content-Type':'application/json'
        },
        body: JSON.stringify({files:{[GIST_FILENAME]:{content:JSON.stringify(data,null,2)}}})
    });
}
async function loadFromGist(){
    if(!GITHUB_TOKEN) return;
    try{
        const r=await fetch(`https://api.github.com/gists/${GIST_ID}`,{headers:{'Authorization':'Bearer '+GITHUB_TOKEN}});
        const g=await r.json();
        if(!g.files[GIST_FILENAME]) return;
        points.forEach(p=>map.geoObjects.remove(p.pm));
        points=[];
        JSON.parse(g.files[GIST_FILENAME].content).forEach(p=>{
            const np=addPoint([p.lat,p.lon]);
            np.azimuth=p.azimuth||0;
            np.commands=p.commands||[];
        });
        updateAllMarkers();
    }catch(e){console.error(e);}
}
function autoSaveGist(){if(points.length && GITHUB_TOKEN) updateGist();}
</script>
</body>
</html>
