<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–æ–≤</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU"></script>

<style>
html,body{margin:0;height:100%;font-family:Arial}
#map{position:absolute;inset:0}

#panel{
    position:absolute;right:10px;top:10px;z-index:10;
    width:360px;max-height:90%;
    background:rgba(255,255,255,.95);
    border-radius:8px;padding:8px;overflow:auto
}

#list{
    max-height:200px;
    overflow-y:auto;
    border:1px solid #ccc;
    padding:2px;
    margin-top:5px;
}

#list div{
    padding:6px;
    border-bottom:1px solid #ddd;
    cursor:pointer;
    word-break: break-word;
}
#list div.active{
    background:#d0f5d0;font-weight:bold
}

input, button, select{
    width:100%;
    margin-top:5px;
    box-sizing:border-box;
}

.command-block{
    margin-bottom:5px;
    border:1px solid #ccc;
    padding:3px;
    border-radius:4px;
    position:relative;
}

.command-block button{
    position:absolute;
    right:3px;
    top:3px;
    width:auto;
    padding:2px 6px;
    font-size:12px;
}

#cmdContainer{
    max-height:150px;
    overflow-y:auto;
}

.az-btns button{
    width:48%;font-size:18px
}

.coord{
    margin-top:5px;
    font-size:14px;
}
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
<b>–ú–∞—Ä—à—Ä—É—Ç</b>
<div id="list"></div>

<hr>
<b>–ö–æ–º–∞–Ω–¥—ã —Ç–æ—á–∫–∏</b>
<div id="cmdContainer"></div>
<button onclick="addCommand()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É</button>

<hr>
<b>–¢–æ—á–∫–∞</b>
<div class="az-btns">
<button onclick="rotate(-10)">‚ü≤ ‚àí10¬∞</button>
<button onclick="rotate(10)">‚ü≥ +10¬∞</button>
</div>
<input id="az" type="number" placeholder="–ê–∑–∏–º—É—Ç">
<div class="coord" id="coord">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ‚Äî , ‚Äî</div>

<button onclick="removePoint()">–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É</button>

<hr>
<b>JSON</b>
<button onclick="exportJSON()">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
<button onclick="importJSON()">–ò–º–ø–æ—Ä—Ç JSON</button>

<hr>
<b>GitHub Gist</b>
<button onclick="updateGist()">üíæ –û–±–Ω–æ–≤–∏—Ç—å Gist</button>
<button onclick="loadFromGist()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Gist</button>
</div>

<script>
let map;
let points = [];
let current = null;

/* === GITHUB GIST (–í–ê–†–ò–ê–ù–¢ 2) === */
const GITHUB_TOKEN = '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';
const GIST_ID = 'c4b196bd97194e06592b94646e02118b';
const GIST_FILENAME = 'all.json';

/* === –°–ü–ò–°–û–ö –ö–û–ú–ê–ù–î === */
const COMMAND_OPTIONS = [
    '–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ',
    '–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–µ–¥–µ–º –ø—Ä—è–º–æ',
    '–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ',
    '–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –≤—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç',

    '–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –ø–µ—Ä–≤—ã–π —Å—ä–µ–∑–¥',
    '–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –≤—Ç–æ—Ä–æ–π —Å—ä–µ–∑–¥',
    '–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —Ç—Ä–µ—Ç–∏–π —Å—ä–µ–∑–¥',
    '–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —á–µ—Ç–≤–µ—Ä—Ç—ã–π —Å—ä–µ–∑–¥',

    '–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞',
    '–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–º –º–µ—Å—Ç–µ',

    '–ù–∞ –±–ª–∏–∂–∞–π—à–µ–º –ø–æ–≤–æ—Ä–æ—Ç–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ',
    '–ù–∞ –±–ª–∏–∂–∞–π—à–µ–º –ø–æ–≤–æ—Ä–æ—Ç–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ',

    '–ù–∞–π–¥–∏—Ç–µ –º–µ—Å—Ç–æ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å',
    '–í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∫—Ä–∞—é –ø—Ä–æ–µ–∑–∂–µ–π —á–∞—Å—Ç–∏',

    '–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏',
    '–ù–∞–±–∏—Ä–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –¥–∞–Ω–Ω–æ–º —É—á–∞—Å—Ç–∫–µ –¥–æ—Ä–æ–≥–∏',

    '–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ',
    '–í—ã–ø–æ–ª–Ω–∏–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ'
];

let list, cmdContainer, az, coord;

window.onload=()=>{
    list=document.getElementById('list');
    cmdContainer=document.getElementById('cmdContainer');
    az=document.getElementById('az');
    coord=document.getElementById('coord');
};

/* INIT MAP */
ymaps.ready(()=>{
    map=new ymaps.Map("map",{
        center:[56.3399,43.9332],
        zoom:18,
        type:'yandex#satellite',
        controls:[]
    });

    map.events.add('click',e=>{
        addPoint(e.get('coords'));
    });
});

/* SVG ARROW */
function arrowSVG(a,color){
    return 'data:image/svg+xml;utf8,'+encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
<g transform="rotate(${a},20,20)">
<polygon points="20,2 28,30 20,24 12,30" fill="${color}"/>
</g>
</svg>`);
}

/* ADD POINT */
function addPoint(coords){
    const p={
        lat:coords[0],
        lon:coords[1],
        azimuth:0,
        commands:[''],
        pm:null
    };

    p.pm=new ymaps.Placemark(coords,{},{
        iconLayout:'default#image',
        iconImageHref:arrowSVG(0,'blue'),
        iconImageSize:[40,40],
        iconImageOffset:[-20,-20],
        draggable:true
    });

    p.pm.events.add('click',()=>selectPoint(p));
    p.pm.events.add('dragstart',()=>selectPoint(p));
    p.pm.events.add('geometrychange',()=>{
        const c=p.pm.geometry.getCoordinates();
        p.lat=c[0]; p.lon=c[1];
        if(current!==p) selectPoint(p);
    });

    map.geoObjects.add(p.pm);
    points.push(p);
    selectPoint(p);
    renderList();
}

/* SELECT */
function selectPoint(p){
    current=p;
    az.value=p.azimuth;
    renderCmdContainer();
    renderList();
    updateMarker(p);
    updateCoord();
}

/* LIST */
function renderList(){
    list.innerHTML='';
    points.forEach(p=>{
        const d=document.createElement('div');
        d.textContent=p.commands[0]||'(–±–µ–∑ –∫–æ–º–∞–Ω–¥—ã)';
        if(p===current) d.classList.add('active');
        d.onclick=()=>selectPoint(p);
        list.appendChild(d);
    });
}

/* COMMANDS */
function renderCmdContainer(){
    cmdContainer.innerHTML='';
    if(!current) return;

    current.commands.forEach((cmd,i)=>{
        const b=document.createElement('div');
        b.className='command-block';

        const sel=document.createElement('select');

        const empty=document.createElement('option');
        empty.value='';
        empty.textContent='‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É ‚Äî';
        sel.appendChild(empty);

        COMMAND_OPTIONS.forEach(t=>{
            const o=document.createElement('option');
            o.value=t;
            o.textContent=t;
            sel.appendChild(o);
        });

        sel.value=cmd||'';
        sel.onchange=()=>{
            current.commands[i]=sel.value;
            renderList();
        };

        const del=document.createElement('button');
        del.textContent='üóë';
        del.onclick=()=>{
            current.commands.splice(i,1);
            renderCmdContainer();
            renderList();
        };

        b.appendChild(sel);
        b.appendChild(del);
        cmdContainer.appendChild(b);
    });
}

function addCommand(){
    if(!current) return;
    current.commands.push('');
    renderCmdContainer();
}

/* AZIMUTH */
az.oninput=()=>{
    if(!current) return;
    current.azimuth=((+az.value%360)+360)%360;
    updateMarker(current);
};

function rotate(d){
    if(!current) return;
    current.azimuth=(current.azimuth+d+360)%360;
    az.value=current.azimuth;
    updateMarker(current);
}

function updateMarker(p){
    p.pm.options.set(
        'iconImageHref',
        arrowSVG(p.azimuth,p===current?'green':'blue')
    );
}

/* COORD */
function updateCoord(){
    coord.textContent=current
        ?`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${current.lat.toFixed(6)} , ${current.lon.toFixed(6)}`
        :'–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ‚Äî , ‚Äî';
}

/* REMOVE */
function removePoint(){
    if(!current) return;
    map.geoObjects.remove(current.pm);
    points=points.filter(p=>p!==current);
    current=null;
    renderList();
    cmdContainer.innerHTML='';
    updateCoord();
}

/* JSON */
function exportJSON(){
    const data=points.map(p=>({
        lat:p.lat,lon:p.lon,azimuth:p.azimuth,commands:p.commands
    }));
    const blob=new Blob(
        ["\uFEFF"+JSON.stringify(data,null,2)],
        {type:'application/json;charset=utf-8'}
    );
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='route.json';
    a.click();
}

function importJSON(){
    const i=document.createElement('input');
    i.type='file'; i.accept='.json';
    i.onchange=e=>{
        const r=new FileReader();
        r.onload=ev=>{
            const arr=JSON.parse(ev.target.result);
            points.forEach(p=>map.geoObjects.remove(p.pm));
            points=[]; current=null;
            arr.forEach(p=>{
                const np=addPoint([p.lat,p.lon]);
                np.azimuth=p.azimuth||0;
                np.commands=p.commands?.length?p.commands:[''];
                updateMarker(np);
            });
        };
        r.readAsText(e.target.files[0],'UTF-8');
    };
    i.click();
}

/* ===== GIST ===== */
async function updateGist(){
    if(!GITHUB_TOKEN){
        alert('–ù–µ —É–∫–∞–∑–∞–Ω GitHub token');
        return;
    }

    const data=points.map(p=>({
        lat:p.lat,lon:p.lon,azimuth:p.azimuth,commands:p.commands
    }));

    const files={};
    files[GIST_FILENAME]={content:JSON.stringify(data,null,2)};

    const res=await fetch('https://api.github.com/gists/'+GIST_ID,{
        method:'PATCH',
        headers:{
            'Authorization':'Bearer '+GITHUB_TOKEN,
            'Accept':'application/vnd.github+json'
        },
        body:JSON.stringify({files})
    });

    if(res.ok) alert('Gist –æ–±–Ω–æ–≤–ª—ë–Ω');
    else alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
}

async function loadFromGist(){
    const res=await fetch('https://api.github.com/gists/'+GIST_ID,{
        headers:{'Authorization':'Bearer '+GITHUB_TOKEN}
    });

    const gist=await res.json();
    const arr=JSON.parse(gist.files[GIST_FILENAME].content);

    points.forEach(p=>map.geoObjects.remove(p.pm));
    points=[]; current=null;

    arr.forEach(p=>{
        const np=addPoint([p.lat,p.lon]);
        np.azimuth=p.azimuth||0;
        np.commands=p.commands?.length?p.commands:[''];
        updateMarker(np);
    });

    alert('–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
}
</script>
</body>
</html>
