<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–æ–≤</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU"></script>
<style>
html,body{margin:0;height:100%;font-family:'Inter',Arial}
#map{position:absolute;inset:0}
#panel{position:absolute; right:10px; top:10px;width:360px;max-width:95%;background:rgba(255,255,255,0.28);backdrop-filter:blur(20px);border-radius:16px;padding:16px;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,0.25);transition:transform .3s ease, opacity .3s ease;}
#panel.collapsed{transform:translateX(110%);opacity:0.3;}
#panelToggle{position:fixed; top:12px; right:12px;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#4a90e2,#2f80ed);color:white;border:none;cursor:pointer;font-size:22px; z-index:1001;box-shadow:0 4px 12px rgba(0,0,0,0.35);}
#panelToggle:hover{background:linear-gradient(135deg,#6aa6f3,#3f90ff);}
button,input{margin-top:8px;border-radius:12px;font-size:14px;padding:10px;border:1px solid rgba(0,0,0,0.15);outline:none; transition:all .2s ease;}
input:focus{border-color:#2f80ed;box-shadow:0 0 8px rgba(47,128,237,0.4);}
button{background:#2f80ed;color:white;border:none;cursor:pointer;}
button.secondary{background:#aaa} button.danger{background:#e74c3c}
button:hover{opacity:0.85;}
.az-row{display:flex;gap:8px} .az-row button{height:56px;font-size:20px;flex:1;}
.info{margin-top:8px;font-size:14px;white-space:pre-line;cursor:pointer;padding:10px;border-radius:12px;background:rgba(0,0,0,0.05);transition:background .2s ease;}
.info:hover{background:rgba(0,0,0,0.08);}
.command-dropdown{position:fixed; right:10px; top:10px;width:360px;max-width:95%;max-height:calc(100vh-20px);background:rgba(255,255,255,0.95);border-radius:16px;padding:8px 16px;box-shadow:0 20px 40px rgba(0,0,0,0.35);overflow:auto; z-index:1500; display:flex; flex-direction:column; transition:opacity .3s ease;}
.command-dropdown label{display:flex; gap:8px; align-items:center; padding:4px 6px; border-radius:8px; cursor:pointer; transition:background .2s ease; font-size:13px;}
.command-dropdown label:hover{background:rgba(47,128,237,0.08);}
.command-dropdown input[type=checkbox]{width:16px; height:16px; min-width:16px; min-height:16px;}
.cmd-buttons{display:flex;gap:12px;margin-top:12px}
.cmd-buttons button{flex:1;padding:10px 0;font-weight:bold;border-radius:12px;}
.cmd-buttons button.secondary{background:#aaa;} .cmd-buttons button:hover{opacity:0.9;}
#tokenPrompt{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:2000;}
#tokenPrompt div{background:white;padding:24px;border-radius:16px;max-width:90%;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.35);}
#tokenPrompt input{width:100%;margin-top:12px;}
#tokenPrompt button{margin-top:12px;width:100%;}
#tokenMessage{font-weight:bold;}
#tokenError{color:red;margin-top:8px;font-size:14px;}
#customCmdRow{display:flex;gap:6px; margin-top:8px;}
#customCmdRow input{flex:1;} 
#customCmdRow button{width:60px;}
</style>
</head>
<body>

<div id="map"></div>

<button id="panelToggle" onclick="togglePanel()">‚Æú</button>

<div id="panel">
    <div class="info" id="pointInfo" onclick="toggleCommandDropdown()">–¢–æ—á–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>

    <div class="az-row">
        <button onclick="rotate(-10)">‚ü≤</button>
        <button onclick="rotate(10)">‚ü≥</button>
    </div>

    <div class="info" id="coordInfo">‚Äî</div>

    <div class="info">
        –¶–≤–µ—Ç –º–µ—Ç–∫–∏:
        <div id="colorPalette" style="display:flex;gap:6px;margin-top:6px;"></div>
    </div>

    <div id="customCmdRow">
        <input id="customCmd" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É">
        <button onclick="addCustomCommand()">‚úÖ</button>
    </div>

    <button class="danger" onclick="removePoint()">–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É</button>

    <hr>
    <button onclick="exportJSON()">üì§ –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <button onclick="importJSON()">üì• –ò–º–ø–æ—Ä—Ç JSON</button>

    <hr>
    <button onclick="updateGist()">üíæ –û–±–Ω–æ–≤–∏—Ç—å Gist</button>
    <button id="toggleLocationBtn" onclick="toggleAutoLocation()">üìç –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è: –í–∫–ª</button>
</div>

<div id="tokenPrompt" style="display:none">
    <div>
        <div id="tokenMessage">–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω GitHub Gist:</div>
        <input type="text" id="gistTokenInput" placeholder="ghp_...">
        <button onclick="saveToken()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div id="tokenError"></div>
    </div>
</div>

<script>
let map, points=[], current=null, userLocationMarker=null;
let panelCollapsed=false;
let GITHUB_TOKEN=localStorage.getItem('GITHUB_TOKEN')||'';
let locationInterval=null;
let autoLocationEnabled = true;

const GIST_ID='c4b196bd97194e06592b94646e02118b';
const GIST_FILENAME='all.json';
const COMMANDS=[
'–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ª–µ–≤–æ','–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–µ–¥–µ–º –ø—Ä—è–º–æ','–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ','–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ –≤—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç',
'–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –ø–µ—Ä–≤—ã–π —Å—ä–µ–∑–¥','–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –≤—Ç–æ—Ä–æ–π —Å—ä–µ–∑–¥','–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —Ç—Ä–µ—Ç–∏–π —Å—ä–µ–∑–¥','–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —á–µ—Ç–≤–µ—Ä—Ç—ã–π —Å—ä–µ–∑–¥',
'–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤–Ω–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–∞','–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–º –º–µ—Å—Ç–µ',
'–ù–∞ –±–ª–∏–∂–∞–π—à–µ–º –ø–æ–≤–æ—Ä–æ—Ç–µ –ø–æ–≤–µ—Ä–Ω–µ–º –Ω–∞–ø—Ä–∞–≤–æ','–ù–∞ –±–ª–∏–∂–∞–π—à–µ–º –ø–æ–≤–æ—Ä–æ—Ç–µ –Ω–∞–ª–µ–≤–æ',
'–ù–∞–π–¥–∏—Ç–µ –º–µ—Å—Ç–æ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å','–í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∫—Ä–∞—é –ø—Ä–æ–µ–∑–∂–µ–π —á–∞—Å—Ç–∏',
'–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–≥–æ–Ω –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏','–ù–∞–±–∏—Ä–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –¥–∞–Ω–Ω–æ–º —É—á–∞—Å—Ç–∫–µ –¥–æ—Ä–æ–≥–∏',
'–í—ã–ø–æ–ª–Ω–∏–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ','–í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É –∏ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ'
];

const COLOR_PALETTE = [
    {name:'blue'},
    {name:'red'},
    {name:'orange'},
    {name:'purple'},
    {name:'green'},
    {name:'gray'}
];

// ====== INIT ======
if(!GITHUB_TOKEN) showTokenPrompt();
else initMap();

// ====== PANEL ======
function togglePanel(){
    panelCollapsed = !panelCollapsed;
    document.getElementById('panel').classList.toggle('collapsed', panelCollapsed);
    document.getElementById('panelToggle').textContent = panelCollapsed?'‚Æû':'‚Æú';
}

// ====== TOKEN ======
function showTokenPrompt(message='–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω GitHub Gist:'){
    document.getElementById('tokenPrompt').style.display='flex';
    document.getElementById('tokenMessage').textContent = message;
    document.getElementById('gistTokenInput').value = '';
    document.getElementById('tokenError').textContent = '';
}

async function saveToken(){
    const t = document.getElementById('gistTokenInput').value.trim();
    if(!t) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω!');
    try{
        const r = await fetch(`https://api.github.com/gists/${GIST_ID}`, { headers:{'Authorization':'Bearer '+t} });
        if(!r.ok) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ Gist ID!');
        GITHUB_TOKEN = t;
        localStorage.setItem('GITHUB_TOKEN', GITHUB_TOKEN);
        document.getElementById('tokenPrompt').style.display = 'none';
        initMap();
    }catch(e){
        document.getElementById('tokenError').textContent = e.message;
        console.error(e);
    }
}

// ====== MAP ======
async function initMap(){
    ymaps.ready(async ()=>{
        const savedView = JSON.parse(localStorage.getItem('mapView')||'null');
        const center = savedView?.center || [56.3399,43.9332];
        const zoom = savedView?.zoom || 18;

        map = new ymaps.Map("map", { center, zoom, type:'yandex#satellite', controls:[] });
        map.events.add('click', e=>addPoint(e.get('coords')));
        map.events.add('boundschange', e => localStorage.setItem('mapView', JSON.stringify({center: map.getCenter(), zoom: map.getZoom()})));

        startAutoLocation(); // –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏

        // —Å–æ–∑–¥–∞–µ–º –ø–∞–ª–∏—Ç—Ä—É
        const paletteDiv = document.querySelector('#colorPalette');
        COLOR_PALETTE.forEach(c=>{
            const btn = document.createElement('button');
            btn.style.background = c.name;
            btn.title = c.name;
            btn.onclick = ()=>setPointColor(c.name);
            paletteDiv.appendChild(btn);
        });

        await loadFromGist();
    });
}

// ====== USER LOCATION ======
function showUserLocation(){
    if(!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos=>{
        const coords = [pos.coords.latitude, pos.coords.longitude];
        if(!userLocationMarker){
            userLocationMarker = new ymaps.Placemark(coords, {hintContent:'–í—ã –∑–¥–µ—Å—å', balloonContent:'–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'}, {preset:'islands#blueCircleIcon', iconSize:[12,12]});
            map.geoObjects.add(userLocationMarker);
        } else userLocationMarker.geometry.setCoordinates(coords);
    });
}

function startAutoLocation(){
    if(locationInterval) clearInterval(locationInterval);
    if(autoLocationEnabled) locationInterval = setInterval(showUserLocation, 5000);
}

function toggleAutoLocation(){
    autoLocationEnabled = !autoLocationEnabled;
    document.getElementById('toggleLocationBtn').textContent = `üìç –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è: ${autoLocationEnabled?'–í–∫–ª':'–í—ã–∫–ª'}`;
    startAutoLocation();
}

// ====== POINTS ======
function round6(n){ return +n.toFixed(6); }

function arrowSVG(a,colorName,selected=false){
    const fill = colorName || 'blue';
    const stroke = selected?'#2ecc71':'black';
    const sw = selected?3:1;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><g transform="rotate(${a},20,20)"><polygon points="20,2 28,30 20,24 12,30" fill="${fill}" stroke="${stroke}" stroke-width="${sw}"/></g></svg>`);
}

function addPoint(c){
    const lat = round6(c[0]), lon = round6(c[1]);
    const p = {lat, lon, azimuth:0, commands:[], color:'blue', pm:null};
    p.pm = new ymaps.Placemark([lat, lon], {}, {iconLayout:'default#image', iconImageSize:[40,40], iconImageOffset:[-20,-20], draggable:true});
    p.pm.events.add('click', () => selectPoint(p));
    p.pm.events.add('dragend', e => {
        const coords = e.get('target').geometry.getCoordinates();
        p.lat = round6(coords[0]); p.lon = round6(coords[1]);
        updateInfo(); updateAllMarkers();
    });
    map.geoObjects.add(p.pm);
    points.push(p); selectPoint(p);
    return p;
}

function selectPoint(p){ document.querySelector('.command-dropdown')?.remove(); current=p; updateInfo(); updateAllMarkers(); }
function removePoint(){ if(!current)return; map.geoObjects.remove(current.pm); points = points.filter(x=>x!==current); current=null; updateInfo(); updateAllMarkers(); }
function rotate(d){ if(!current) return; current.azimuth=(current.azimuth+d+360)%360; updateAllMarkers(); updateInfo(); }
function setPointColor(name){ if(!current)return; current.color=name; updateAllMarkers(); }
function updateAllMarkers(){ points.forEach(p=>p.pm.options.set('iconImageHref', arrowSVG(p.azimuth,p.color,p===current))); }
function updateInfo(){ if(!current){document.getElementById('pointInfo').textContent='–¢–æ—á–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞';document.getElementById('coordInfo').textContent='‚Äî';return;} document.getElementById('pointInfo').textContent=current.commands.join('\n')||'(–Ω–µ—Ç –∫–æ–º–∞–Ω–¥)'; document.getElementById('coordInfo').textContent=`${current.lat}, ${current.lon}\n–ê–∑–∏–º—É—Ç: ${current.azimuth}¬∞`; }

// ====== COMMANDS ======
function toggleCommandDropdown(){
    if(!current)return;
    let d=document.querySelector('.command-dropdown'); if(d){d.remove(); return;}
    d=document.createElement('div'); d.className='command-dropdown';
    COMMANDS.forEach(c=>{
        const l=document.createElement('label'); const cb=document.createElement('input');
        cb.type='checkbox'; cb.checked=current.commands.includes(c);
        l.appendChild(cb); l.appendChild(document.createTextNode(c));
        d.appendChild(l);
    });
    const btns=document.createElement('div'); btns.className='cmd-buttons';
    const ok=document.createElement('button'); ok.textContent='–ì–æ—Ç–æ–≤–æ';
    ok.onclick=()=>{current.commands=[...d.querySelectorAll('input:checked')].map(x=>x.parentNode.textContent.trim()); updateInfo(); updateAllMarkers(); d.remove();}
    const cancel=document.createElement('button'); cancel.textContent='–û—Ç–º–µ–Ω–∞'; cancel.className='secondary'; cancel.onclick=()=>d.remove();
    btns.append(ok,cancel); d.appendChild(btns); document.body.appendChild(d);
}

function addCustomCommand(){ if(!current)return; const i=document.getElementById('customCmd'); if(!i.value.trim()) return; current.commands.push(i.value.trim()); i.value=''; updateInfo(); updateAllMarkers(); }

// ====== JSON ======
function exportJSON(){ const data = points.map(p=>({lat:p.lat,lon:p.lon,azimuth:p.azimuth,color:p.color,commands:p.commands})); const b = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='route.json'; a.click(); }

function importJSON(){ const i=document.createElement('input'); i.type='file'; i.accept='.json'; i.onchange=e=>{ const r=new FileReader(); r.onload=()=>{ points.forEach(p=>map.geoObjects.remove(p.pm)); points=[]; JSON.parse(r.result).forEach(p=>{const np=addPoint([round6(p.lat),round6(p.lon)]); np.azimuth=p.azimuth||0; np.commands=p.commands||[]; np.color=p.color||'blue'; }); updateAllMarkers(); }; r.readAsText(e.target.files[0]); }; i.click(); }

// ====== GIST ======
async function updateGist(){ 
    if(!GITHUB_TOKEN) return showTokenPrompt('–¢—Ä–µ–±—É–µ—Ç—Å—è GitHub —Ç–æ–∫–µ–Ω!'); 
    const data=points.map(p=>({lat:p.lat,lon:p.lon,azimuth:p.azimuth,color:p.color,commands:p.commands}));
    try{
        const r=await fetch(`https://api.github.com/gists/${GIST_ID}`,{method:'PATCH',headers:{'Authorization':'Bearer '+GITHUB_TOKEN,'Content-Type':'application/json'},body: JSON.stringify({files:{[GIST_FILENAME]:{content:JSON.stringify(data,null,2)}}})});
        if(!r.ok){if(r.status===401) showTokenPrompt('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω:'); else if(r.status===403) alert('–¢–æ–∫–µ–Ω –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Gist.'); else if(r.status===404) alert('Gist –Ω–µ –Ω–∞–π–¥–µ–Ω.'); else alert(`–û—à–∏–±–∫–∞: ${r.status} ${r.statusText}`);} 
        else alert('Gist —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!');
    }catch(e){alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å Gist: '+e.message);}
}

async function loadFromGist(){
    if(!GITHUB_TOKEN) return showTokenPrompt('–¢—Ä–µ–±—É–µ—Ç—Å—è GitHub —Ç–æ–∫–µ–Ω!');
    try{
        const r=await fetch(`https://api.github.com/gists/${GIST_ID}`,{headers:{'Authorization':'Bearer '+GITHUB_TOKEN}});
        if(!r.ok){if(r.status===401) showTokenPrompt('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω:'); else if(r.status===403) alert('–¢–æ–∫–µ–Ω –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ Gist.'); else if(r.status===404) alert('Gist –Ω–µ –Ω–∞–π–¥–µ–Ω.'); else alert(`–û—à–∏–±–∫–∞: ${r.status} ${r.statusText}`); return;}
        const g = await r.json();
        if(!g.files[GIST_FILENAME]) return;
        points.forEach(p=>map.geoObjects.remove(p.pm));
        points=[];
        JSON.parse(g.files[GIST_FILENAME].content).forEach(p=>{
            const np=addPoint([round6(p.lat),round6(p.lon)]);
            np.azimuth=p.azimuth||0;
            np.commands=p.commands||[];
            np.color=p.color||'blue';
        });
        updateAllMarkers();
    }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Gist: '+e.message); }
}
</script>
</body>
</html>
